language: python
env:
  global:
    # AWS keys
    - secure: "Nw/GKObNzAgIyBrMnFTyxH7y5VhXYDDeLkf2Jusnbf6pGG/hwPuuFgfRmVs8rKl99oSIruR6CIpA2iYcBJMgdqevXS1YFT6YeN4g0K61FX1UjLmxjfoyM3Knbegwr9GeR2KndkpP+8wjqJB0gIYdLfNwj0F/d3koQMwWmW1m3I4="
    - secure: "Nj8okJzwOyrcW7BrXkpwfwVZuUVvwMaiFU4CzmlLL3G1zGiwtrI56Ewcluyu/2HanjJ+WZ7gtZmOWwS3uaxR70z8tw1iBCg5joZJM5HMss5Djpv4bf33e7sOxbfJcMXAzoUDZXcqraIiVHermpWTkExR3Asi0ZnMIxuYrliFW/I="
matrix:
  include:
  - os: linux
    python: 2.7
    env: TOKENV=py27 TESTMODE=full COVERAGE=--coverage
  - os: linux
    python: 3.4
    env: TOKENV=py34 TESTMODE=full COVERAGE=--coverage
  - os: osx
    language: generic
    env: TOKENV=py27 TESTMODE=full COVERAGE=--coverage
  - os: osx
    language: generic
    env: TOKENV=py35 TESTMODE=full COVERAGE=--coverage
before_install:
- if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then source .linux_build.sh $TOKENV $TESTMODE;
  fi
- if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then  source .osx_build.sh $TOKENV; fi
script:
- flake8 *.py sima --exclude sima/misc/tifffile.py,sima/__init__.py,test*.py,sima/motion/__init__.py,sima/segment/__init__.py
- if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then python runtests.py --doctests -m $TESTMODE
  $COVERAGE; fi
- if [[ "$TRAVIS_OS_NAME" == "osx" ]] && [[ "$TOKENV" == "py27" ]]; then python runtests.py
  --doctests -m $TESTMODE $COVERAGE; fi
- if [[ "$TRAVIS_OS_NAME" == "osx" ]] && [[ "$TOKENV" == "py35" ]]; then python3 runtests.py
  --doctests -m $TESTMODE $COVERAGE; fi
branches:
  only:
  - master
  - 0.3.x
  - 1.0.x
  - 1.1.x
  - 1.3.x
after_success:
- if [[ "$TRAVIS_PYTHON_VERSION" == "2.7" ]]; then if [ "${TESTMODE}" == "full" ];
  then cp build/test/.coverage . && coveralls; fi; fi
- if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then pip install wheel && python setup.py bdist_wheel; fi
- if [[ "$TRAVIS_OS_NAME" == "osx" ]] && [[ "$TOKENV" == "py27" ]]; then pip install wheel && python setup.py bdist_wheel; fi
- if [[ "$TRAVIS_OS_NAME" == "osx" ]] && [[ "$TOKENV" == "py35" ]]; then pip3 install wheel && python3 setup.py bdist_wheel; fi
- if [[ "$TRAVIS_REPO_SLUG" == "losonczylab/sima" ]] && [[ "$TRAVIS_PULL_REQUEST" == "false" ]] && [[ "$TRAVIS_OS_NAME" == "osx" && "$TOKENV" == "py35" ]]; then pip3 install awscli && aws s3 cp dist s3://losonczylab.sima/${TRAVIS_OS_NAME}_${TOKENV} --recursive; fi
- if [[ "$TRAVIS_REPO_SLUG" == "losonczylab/sima" ]] && [[ "$TRAVIS_PULL_REQUEST" == "false" ]] && [[ "$TRAVIS_OS_NAME" != "osx" || "$TOKENV" != "py35" ]]; then pip install awscli && aws s3 cp dist s3://losonczylab.sima/${TRAVIS_OS_NAME}_${TOKENV} --recursive; fi
